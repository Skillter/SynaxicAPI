<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="User Dashboard - Synaxic API - Manage your API keys and account with enterprise-grade developer utilities">
    <meta name="keywords" content="API dashboard, developer tools, API key management, Synaxic API">
    <meta name="author" content="Skillter">
    <meta name="robots" content="noindex, nofollow">

    <!-- Open Graph / Social Media -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://synaxic.skillter.dev/dashboard">
    <meta property="og:title" content="Dashboard - Synaxic API">
    <meta property="og:description" content="Manage your API keys and account with enterprise-grade developer utilities">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://synaxic.skillter.dev/dashboard">
    <meta property="twitter:title" content="Dashboard - Synaxic API">
    <meta property="twitter:description" content="Manage your API keys and account with enterprise-grade developer utilities">

    <title>Dashboard - Synaxic API</title>

    <!-- Preconnect to external domains -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">

    <link rel="canonical" href="https://synaxic.skillter.dev/dashboard">

    <!-- Structured Data for SEO -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Synaxic API Dashboard",
        "description": "User dashboard for managing API keys and account settings for Synaxic API enterprise-grade developer utilities",
        "url": "https://synaxic.skillter.dev/dashboard",
        "applicationCategory": "DeveloperApplication",
        "applicationSubCategory": "Developer Dashboard",
        "operatingSystem": "Any",
        "browserRequirements": "Requires JavaScript. Requires HTML5.",
        "softwareVersion": "1.0.0",
        "datePublished": "2025-01-01",
        "dateModified": "2025-01-06",
        "author": {
            "@type": "Person",
            "name": "Skillter",
            "url": "https://skillter.dev"
        },
        "creator": {
            "@type": "Person",
            "name": "Skillter",
            "url": "https://skillter.dev"
        },
        "provider": {
            "@type": "Person",
            "name": "Skillter",
            "url": "https://skillter.dev"
        },
        "isPartOf": {
            "@type": "WebApplication",
            "name": "Synaxic API",
            "url": "https://synaxic.skillter.dev"
        },
        "license": "https://synaxic.skillter.dev/terms-of-service",
        "privacyPolicy": "https://synaxic.skillter.dev/privacy-policy"
    }
    </script>

    <!-- Critical CSS for preventing layout shift and above-the-fold content -->
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #8b5cf6;
            --accent: #ec4899;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --bg-card: rgba(30, 41, 59, 0.8);
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --gradient-1: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #ec4899 100%);
            --border-radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            padding-top: 50px; /* Match main.css body padding */
        }

        /* Critical Navigation Styles */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(12px);
            z-index: 1000;
            border-bottom: 1px solid rgba(100, 116, 139, 0.2);
            height: 70px; /* Explicit height to prevent layout shift */
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            height: 100%; /* Ensure full height usage */
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            text-decoration: none;
            transition: var(--transition);
        }

        .logo:hover {
            opacity: 0.8;
        }

        .logo-icon {
            font-size: 32px;
        }

        .nav-links {
            display: flex;
            align-items: center;
            gap: 32px;
        }

        .nav-links a {
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            transition: var(--transition);
            position: relative;
        }

        .nav-links a:hover {
            color: var(--primary-light);
            text-shadow: 0 0 20px rgba(129, 140, 248, 0.5);
        }

        /* Critical Dashboard Layout */
        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px;
            min-height: calc(100vh - 70px);
            padding-top: 40px; /* Proper spacing from navbar */
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 48px;
        }

        .dashboard-title {
            font-size: clamp(36px, 6vw, 72px);
            font-weight: 800;
            line-height: 1.1;
            margin-bottom: 16px;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .dashboard-subtitle {
            font-size: clamp(18px, 2vw, 24px);
            color: var(--text-secondary);
            max-width: 800px;
            margin: 0 auto;
        }

        .dashboard-section {
            background: var(--bg-card);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: var(--border-radius);
            padding: 32px;
            margin-bottom: 32px;
            backdrop-filter: blur(12px);
        }

        .section-header {
            margin-bottom: 24px;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .section-icon {
            font-size: 28px;
        }

        .chart-icon {
            width: 28px;
            height: 28px;
            background: var(--gradient-1);
            border-radius: 50%;
            display: inline-block;
        }

        /* Loading States */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            padding: 40px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(99, 102, 241, 0.2);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--text-muted);
            font-size: 16px;
        }

        /* Account Usage Styles */
        .account-usage-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
            margin-bottom: 32px;
        }

        .usage-header {
            margin-bottom: 24px;
        }

        .usage-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .usage-subtitle {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .usage-stats {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .usage-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .usage-stat-value {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary);
        }

        .usage-stat-label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .usage-stat-divider {
            font-size: 20px;
            color: var(--text-muted);
            margin: 0 4px;
        }

        .donut-chart-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
            position: relative;
        }

        .donut-chart {
            width: 200px;
            height: 200px;
        }

        .donut-chart-center {
            position: absolute;
            text-align: center;
        }

        .donut-percentage {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary);
        }

        .donut-label {
            font-size: 14px;
            color: var(--text-muted);
        }

        /* Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            border-radius: var(--border-radius);
            text-decoration: none;
            border: none;
            cursor: pointer;
            white-space: nowrap;
            transition: var(--transition);
            min-height: 48px;
        }

        .btn-primary {
            background: var(--gradient-1);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.5);
            filter: brightness(1.1);
        }

        .btn-danger {
            background: var(--error);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(239, 68, 68, 0.4);
        }

        /* Cookie Banner */
        .cookie-consent {
            position: fixed;
            bottom: 16px;
            right: 16px;
            left: auto;
            max-width: 380px;
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(100, 116, 139, 0.2);
            border-radius: 8px;
            padding: 12px 16px;
            z-index: 9999;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(120%);
            opacity: 0;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }

        .cookie-consent.show {
            transform: translateY(0);
            opacity: 1;
        }

        .cookie-consent.hidden {
            transform: translateY(120%);
            opacity: 0;
            pointer-events: none;
        }

        .cookie-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .cookie-content p {
            margin: 0;
            font-size: 14px;
            line-height: 1.5;
            color: var(--text-secondary);
        }

        .cookie-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .cookie-buttons .btn {
            padding: 6px 12px;
            font-size: 12px;
            min-height: 32px;
        }

        /* Focus styles for accessibility */
        button:focus-visible,
        input:focus-visible,
        a:focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }

            .dashboard-container {
                padding: 0 16px;
                padding-top: 20px;
            }

            .dashboard-section {
                padding: 24px 20px;
            }

            .account-usage-container {
                grid-template-columns: 1fr;
                gap: 24px;
            }

            .cookie-consent {
                bottom: 8px;
                right: 8px;
                left: 8px;
                max-width: none;
            }
        }

        @media (max-width: 480px) {
            .dashboard-section {
                padding: 20px 16px;
            }
        }

        /* Critical fade-in animation - immediately visible */
        .hero-title,
        .hero-subtitle,
        .hero-stats,
        .hero-cta,
        .dashboard-card,
        .dashboard-grid,
        .dashboard-section,
        .dashboard-widget,
        .stat-card,
        .feature-list,
        .api-endpoint {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
            will-change: opacity, transform;
        }
    </style>

    <link rel="stylesheet" href="/css/main.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="/css/dashboard.css" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="/css/main.css"></noscript>
    <noscript><link rel="stylesheet" href="/css/dashboard.css"></noscript>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="/" class="logo">
                <span class="logo-icon">‚ö°</span>
                <span class="logo-text">Synaxic API</span>
            </a>
            <div class="nav-links">
                <a href="/#features">Features</a>
                <a href="/#demo">Demo</a>
                <a href="/#stack">Tech Stack</a>
                <a href="/#contact">Contact</a>
                <a href="/analytics">Analytics & Health</a>
                <a href="/swagger-ui.html" class="external-link" target="_blank" rel="noopener">API Docs <span class="external-icon">‚Üó</span></a>
                <button id="login-btn" class="btn btn-primary">
                    <span>Dashboard</span>
                </button>
            </div>
            <button class="mobile-menu-btn" id="mobile-menu-btn">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </nav>

    <!-- Dashboard Content -->
    <div class="dashboard-container">
        <!-- Header -->
        <div class="dashboard-header">
            <h1 class="dashboard-title">My Dashboard</h1>
            <p class="dashboard-subtitle">Manage your API keys, view usage statistics, and control your account</p>
        </div>

        <!-- User Profile Section -->
        <div class="dashboard-section">
            <div class="section-header">
                <h2 class="section-title">
                    <span class="section-icon">üë§</span>
                    Profile
                </h2>
            </div>
            <div id="user-profile" class="user-info">
                <div class="loading-container">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">Loading profile...</div>
                </div>
            </div>
        </div>

        <!-- Account Usage Section -->
        <div class="dashboard-section">
            <div class="section-header">
                <h2 class="section-title">
                    <span class="section-icon chart-icon"></span>
                    Account Usage
                </h2>
            </div>

            <!-- Account Quota Visualization -->
            <div class="account-usage-container">
                <div class="usage-header">
                    <div class="usage-info">
                        <h3 class="usage-title">Account Quota Usage</h3>
                        <p class="usage-subtitle">Track your API consumption across all keys</p>
                    </div>
                    <div class="usage-stats">
                        <div class="usage-stat">
                            <span class="usage-stat-value" id="account-used">0</span>
                            <span class="usage-stat-label">Used</span>
                        </div>
                        <div class="usage-stat-divider">/</div>
                        <div class="usage-stat">
                            <span class="usage-stat-value" id="account-limit">10K</span>
                            <span class="usage-stat-label">Limit</span>
                        </div>
                    </div>
                </div>

                <!-- Donut Chart -->
                <div class="donut-chart-container">
                    <svg class="donut-chart" viewBox="0 0 300 300" id="donut-chart">
                        <!-- Donut segments will be dynamically added here -->
                    </svg>
                    <div class="donut-chart-center">
                        <div class="donut-percentage" id="donut-percentage">0%</div>
                        <div class="donut-label">Used</div>
                    </div>
                </div>

                <!-- Legend -->
                <div class="donut-legend" id="donut-legend">
                    <!-- Legend items will be dynamically added here -->
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="dashboard-grid">
            <div class="stat-card-mini">
                <div class="label">Total API Keys</div>
                <div class="value" id="total-keys">0</div>
            </div>
            <div class="stat-card-mini">
                <div class="label">Total Requests</div>
                <div class="value" id="total-requests">0</div>
            </div>
            <div class="stat-card-mini">
                <div class="label">Requests Today</div>
                <div class="value" id="requests-today">0</div>
            </div>
        </div>

        <!-- API Keys Section -->
        <div class="dashboard-section">
            <div class="section-header">
                <h2 class="section-title">
                    <span class="section-icon">üîë</span>
                    API Keys
                </h2>
                <button class="btn btn-primary" onclick="openCreateKeyModal()">
                    <span>+ Create New Key</span>
                </button>
            </div>
            <div id="api-keys-list">
                <div class="loading-container">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">Loading API keys...</div>
                </div>
            </div>
        </div>

        <!-- Privacy & Data Management -->
        <div class="dashboard-section">
            <div class="section-header">
                <h2 class="section-title">
                    <span class="section-icon">üîí</span>
                    Privacy & Data Management
                </h2>
            </div>
            <p style="color: var(--text-secondary); margin-bottom: 24px;">
                Your privacy rights under GDPR and CCPA. Manage your data and control how it's used.
            </p>

            <div class="privacy-action">
                <div class="privacy-action-info">
                    <div class="privacy-action-title">üì• Request Data Copy</div>
                    <div class="privacy-action-desc">Download all data we hold about you in JSON format</div>
                </div>
                <button class="btn btn-secondary" onclick="requestDataExport()">Export Data</button>
            </div>

            <div class="privacy-action">
                <div class="privacy-action-info">
                    <div class="privacy-action-title">üç™ Reset Cookie Consent</div>
                    <div class="privacy-action-desc">Clear your cookie preferences and show the consent banner again</div>
                </div>
                <button class="btn btn-danger" onclick="resetCookieConsent()">Reset Consent</button>
            </div>

            <div class="privacy-action">
                <div class="privacy-action-info">
                    <div class="privacy-action-title">üóëÔ∏è Delete Account</div>
                    <div class="privacy-action-desc">Permanently delete your account and all associated data</div>
                </div>
                <button class="btn btn-danger" onclick="openDeleteAccountModal()">Delete Account</button>
            </div>
        </div>

        <!-- Account Settings -->
        <div class="dashboard-section">
            <div class="section-header">
                <h2 class="section-title">
                    <span class="section-icon">‚öôÔ∏è</span>
                    Account Settings
                </h2>
            </div>
            <div class="privacy-action">
                <div class="privacy-action-info">
                    <div class="privacy-action-title">üîê Security</div>
                    <div class="privacy-action-desc">OAuth2 via Google (managed by your Google account)</div>
                </div>
                <a href="https://myaccount.google.com/security" target="_blank" rel="noopener" class="btn btn-secondary">Manage on Google</a>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-brand">
                    <a href="/" class="logo">
                        <span class="logo-icon">‚ö°</span>
                        <span class="logo-text">Synaxic API</span>
                    </a>
                    <p>Enterprise-grade developer utilities</p>
                </div>
                <div class="footer-copyright">
                    <p>&copy; 2025 Skillter. All rights reserved.</p>
                    <div style="margin-top: 12px; display: flex; gap: 16px; font-size: 14px;">
                        <a href="/privacy-policy" style="color: var(--primary-light);">Privacy Policy</a>
                        <a href="/terms-of-service" style="color: var(--primary-light);">Terms of Service</a>
                        <a href="/fair-use-policy" style="color: var(--primary-light);">Fair Use</a>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Cookie Consent Banner (GDPR Compliant) -->
    <div id="cookie-consent" class="cookie-consent hidden">
        <div class="cookie-content">
            <p><strong>Cookie Notice</strong> - We use essential cookies to provide authentication and session management. We also use analytics cookies to improve our service. You can manage your preferences below.</p>
            <div class="cookie-buttons">
                <button id="cookie-accept-all" class="btn btn-primary">Accept All</button>
                <button id="cookie-essential" class="btn btn-secondary">Essential Only</button>
                <button id="cookie-decline" class="btn btn-text">Decline All</button>
            </div>
        </div>
    </div>

    <!-- Create API Key Modal -->
    <div id="create-key-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create New API Key</h3>
                <button class="modal-close" onclick="closeModal('create-key-modal')">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label" for="key-name">Key Name (optional)</label>
                <input type="text" id="key-name" class="form-input" placeholder="My Production Key">
                <p style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">
                    Give your key a memorable name to identify it later
                </p>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeModal('create-key-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="createApiKey()">Create Key</button>
            </div>
        </div>
    </div>

    <!-- Show New Key Modal -->
    <div id="show-key-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üéâ API Key Created!</h3>
                <button class="modal-close" onclick="closeModal('show-key-modal')">&times;</button>
            </div>
            <div class="alert alert-warning">
                ‚ö†Ô∏è Copy this key now! For security reasons, you won't be able to see it again.
            </div>
            <div class="form-group">
                <label class="form-label">Your New API Key</label>
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="new-key-value" class="form-input" readonly>
                    <button class="btn btn-secondary" onclick="copyNewKey()">Copy</button>
                </div>
            </div>
            <div class="form-actions">
                <button class="btn btn-primary" onclick="closeModal('show-key-modal'); loadApiKeys()">Done</button>
            </div>
        </div>
    </div>

    <!-- Delete Key Confirmation Modal -->
    <div id="delete-key-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">‚ö†Ô∏è Delete API Key</h3>
                <button class="modal-close" onclick="closeModal('delete-key-modal')">&times;</button>
            </div>
            <div class="alert alert-error">
                This action cannot be undone. Applications using this key will immediately stop working.
            </div>
            <p style="color: var(--text-secondary); margin-bottom: 24px;">
                Are you sure you want to delete this API key?
            </p>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeModal('delete-key-modal')">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDeleteKey()">Delete Key</button>
            </div>
        </div>
    </div>

    <!-- Delete Account Modal -->
    <div id="delete-account-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">‚ö†Ô∏è Delete Account</h3>
                <button class="modal-close" onclick="closeModal('delete-account-modal')">&times;</button>
            </div>
            <div class="alert alert-error">
                This action is permanent and cannot be undone!
            </div>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">
                Deleting your account will:
            </p>
            <ul style="color: var(--text-secondary); margin-bottom: 24px; padding-left: 20px;">
                <li>Immediately revoke all your API keys</li>
                <li>Delete all your usage data and statistics</li>
                <li>Remove your account from our system</li>
                <li>Cannot be reversed</li>
            </ul>
            <div class="form-group">
                <label class="form-label">Type "DELETE" to confirm</label>
                <input type="text" id="delete-confirm" class="form-input" placeholder="DELETE">
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeModal('delete-account-modal')">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDeleteAccount()">Delete My Account</button>
            </div>
        </div>
    </div>

    <script src="/js/main.js"></script>
    <script data-cfasync="false">
        const API_BASE = window.location.origin;
        let currentUser = null;
        let keyToDelete = null;
        let apiKeyColors = new Map(); // Store consistent colors for API keys

        // Create authenticated fetch headers
        function getAuthHeaders() {
            const headers = {};

            // Check if we're using API key authentication (look for API key in URL or localStorage)
            const urlParams = new URLSearchParams(window.location.search);
            const apiKey = urlParams.get('api_key') || localStorage.getItem('apiKey');

            if (apiKey) {
                headers['Authorization'] = `ApiKey ${apiKey}`;
            }

            return headers;
        }

        // Create authenticated fetch function
        async function authenticatedFetch(url, options = {}) {
            const authHeaders = getAuthHeaders();
            const headers = {
                ...authHeaders,
                ...(options.headers || {})
            };

            const apiKey = authHeaders.Authorization;
            const response = await fetch(url, {
                ...options,
                headers,
                credentials: apiKey ? 'omit' : 'include'
            });

            // Extract rate limit headers for real-time prediction
            if (response.ok) {
                const rateLimit = response.headers.get('X-RateLimit-Limit');
                const remaining = response.headers.get('X-RateLimit-Remaining');

                if (rateLimit && remaining) {
                    updateRealTimeRateLimit(parseInt(rateLimit), parseInt(remaining));
                }
            }

            return response;
        }

        // Color palette for API keys
        const colorPalette = [
            '#6366f1', // Primary blue
            '#8b5cf6', // Purple
            '#06b6d4', // Cyan
            '#10b981', // Emerald
            '#f59e0b', // Amber
            '#ef4444', // Red
            '#ec4899', // Pink
            '#84cc16', // Lime
            '#f97316', // Orange
            '#14b8a6'  // Teal
        ];

        // Generate consistent color for API key based on its ID
        function getKeyColor(keyId) {
            if (!keyId || typeof keyId !== 'string') {
                keyId = String(keyId || 'unknown');
            }
            if (!apiKeyColors.has(keyId)) {
                const hash = keyId.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
                const colorIndex = hash % colorPalette.length;
                apiKeyColors.set(keyId, colorPalette[colorIndex]);
            }
            return apiKeyColors.get(keyId);
        }

        // Real-time usage prediction system
        class RealTimeUsagePredictor {
            constructor() {
                this.rateLimit = 10000; // Default rate limit
                this.lastServerUpdate = Date.now();
                this.serverRemainingRequests = 10000; // Actual value from server
                this.serverUsedRequests = 0; // Actual value from server
                this.currentRemainingRequests = 10000; // Client-side predicted value
                this.currentUsedRequests = 0; // Client-side predicted value

                // Countdown calculation variables
                this.countdownInterval = null;
                this.serverSyncInterval = null;
                this.countdownIntervalMs = 1000; // Update every second for smooth display
            }

            initialize(rateLimit, usedRequests, remainingRequests) {
                console.log('Initializing usage predictor:', { rateLimit, usedRequests, remainingRequests });
                this.rateLimit = rateLimit;
                this.serverUsedRequests = usedRequests;
                this.serverRemainingRequests = remainingRequests;
                this.currentUsedRequests = usedRequests;
                this.currentRemainingRequests = remainingRequests;
                this.lastServerUpdate = Date.now();

                // Start the countdown timer and update UI
                this.startCountdown();
                this.updateUI();
            }

            startCountdown() {
                // Clear existing intervals
                if (this.countdownInterval) clearInterval(this.countdownInterval);
                if (this.serverSyncInterval) clearInterval(this.serverSyncInterval);

                // Update every second for smooth display
                this.countdownInterval = setInterval(() => {
                    this.updatePredictedUsage();
                }, this.countdownIntervalMs);

                // Sync with server every 30 seconds to correct drift
                this.serverSyncInterval = setInterval(() => {
                    this.syncWithServer();
                }, 30000);
            }

            updatePredictedUsage() {
                const now = Date.now();
                const timeSinceLastUpdate = (now - this.lastServerUpdate) / 1000; // seconds

                // Predict usage based on time elapsed
                // This is a simple linear prediction - you can make this more sophisticated
                const predictedIncrease = Math.max(0, timeSinceLastUpdate * 0.1); // Rough estimate

                this.currentUsedRequests = Math.min(
                    this.serverUsedRequests + predictedIncrease,
                    this.rateLimit
                );
                this.currentRemainingRequests = Math.max(
                    0,
                    this.rateLimit - this.currentUsedRequests
                );

                // Update UI
                this.updateUI();
            }

            updateFromRateLimitHeaders(limit, remaining) {
                // Validate and sanitize header data
                if (!limit || limit <= 0 || !Number.isInteger(limit)) {
                    console.warn('Invalid rate limit from headers:', limit);
                    return; // Ignore invalid data
                }

                if (!remaining || remaining < 0 || remaining > limit) {
                    console.warn('Invalid remaining requests from headers:', { limit, remaining });
                    return; // Ignore invalid data
                }

                // Only update if this is for the account-level tier (10000 requests)
                // Skip lower-tier limits like static resources (1000 requests)
                if (limit < 5000) {
                    console.log('Ignoring lower-tier rate limit:', limit);
                    return;
                }

                const calculatedUsed = limit - remaining;

                // Validate calculated used value
                if (calculatedUsed < 0 || calculatedUsed > limit) {
                    console.warn('Invalid calculated usage from headers:', { limit, remaining, calculatedUsed });
                    return;
                }

                // Update server data and reset client prediction to match
                // Ensure all values are integers
                this.rateLimit = Math.floor(limit);
                this.serverRemainingRequests = Math.floor(remaining);
                this.serverUsedRequests = Math.floor(calculatedUsed);
                this.currentRemainingRequests = Math.floor(remaining);
                this.currentUsedRequests = Math.floor(calculatedUsed);
                this.lastServerUpdate = Date.now();

                console.log('Updated usage from headers:', {
                    limit: this.rateLimit,
                    used: this.currentUsedRequests,
                    remaining: this.currentRemainingRequests,
                    timeSinceUpdate: 0
                });
            }

            syncWithServer() {
                // Sync with actual server data to correct prediction drift
                fetchAccountUsage();
            }

            updateUI() {
                // Update account-level usage displays
                const accountUsedEl = document.getElementById('account-used');
                const accountLimitEl = document.getElementById('account-limit');
                const donutPercentageEl = document.getElementById('donut-percentage');

                if (accountUsedEl) {
                    accountUsedEl.textContent = this.formatNumber(this.currentUsedRequests);
                }
                if (accountLimitEl) {
                    accountLimitEl.textContent = this.formatNumber(this.rateLimit);
                }
                if (donutPercentageEl) {
                    const percentage = Math.round((this.currentUsedRequests / this.rateLimit) * 100);
                    donutPercentageEl.textContent = percentage + '%';
                }

                // Update donut chart
                this.updateDonutChart();
            }

            updateDonutChart() {
                const used = this.currentUsedRequests;
                const limit = this.rateLimit;
                const remaining = limit - used;

                console.log('Updating donut chart:', { used, limit, remaining });
                if (remaining < 0) {
                    console.log('Donut chart update skipped: negative remaining');
                    return; // Don't update if data is invalid
                }

                const percentage = (used / limit) * 100;
                const angle = (percentage / 100) * 360;

                const svg = document.getElementById('donut-chart');
                if (!svg) return;

                const radius = 120;
                const centerX = 150;
                const centerY = 150;

                // Create the donut chart path
                const path = this.createDonutPath(centerX, centerY, radius, 60, 0, angle);

                // Clear existing content
                svg.innerHTML = '';

                // Background circle
                const bgCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                bgCircle.setAttribute('cx', centerX);
                bgCircle.setAttribute('cy', centerY);
                bgCircle.setAttribute('r', radius);
                bgCircle.setAttribute('fill', 'none');
                bgCircle.setAttribute('stroke', 'rgba(99, 102, 241, 0.1)');
                bgCircle.setAttribute('stroke-width', '40');
                svg.appendChild(bgCircle);

                // Usage arc
                if (used > 0) {
                    const pathElement = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    pathElement.setAttribute('d', path);
                    pathElement.setAttribute('fill', 'none');
                    pathElement.setAttribute('stroke', 'url(#gradient)');
                    pathElement.setAttribute('stroke-width', '40');
                    pathElement.setAttribute('stroke-linecap', 'round');

                    // Create gradient
                    const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
                    const gradient = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
                    gradient.setAttribute('id', 'gradient');
                    gradient.setAttribute('x1', '0%');
                    gradient.setAttribute('y1', '0%');
                    gradient.setAttribute('x2', '100%');
                    gradient.setAttribute('y2', '100%');

                    const stop1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
                    stop1.setAttribute('offset', '0%');
                    stop1.setAttribute('stop-color', '#6366f1');

                    const stop2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
                    stop2.setAttribute('offset', '50%');
                    stop2.setAttribute('stop-color', '#8b5cf6');

                    const stop3 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
                    stop3.setAttribute('offset', '100%');
                    stop3.setAttribute('stop-color', '#ec4899');

                    gradient.appendChild(stop1);
                    gradient.appendChild(stop2);
                    gradient.appendChild(stop3);
                    defs.appendChild(gradient);
                    svg.appendChild(defs);
                    svg.appendChild(pathElement);
                }

                // Update legend
                this.updateLegend(used, remaining);
            }

            createDonutPath(cx, cy, outerRadius, innerRadius, startAngle, endAngle) {
                const startAngleRad = (startAngle - 90) * Math.PI / 180;
                const endAngleRad = (endAngle - 90) * Math.PI / 180;

                const x1 = cx + outerRadius * Math.cos(startAngleRad);
                const y1 = cy + outerRadius * Math.sin(startAngleRad);
                const x2 = cx + outerRadius * Math.cos(endAngleRad);
                const y2 = cy + outerRadius * Math.sin(endAngleRad);

                const x3 = cx + innerRadius * Math.cos(endAngleRad);
                const y3 = cy + innerRadius * Math.sin(endAngleRad);
                const x4 = cx + innerRadius * Math.cos(startAngleRad);
                const y4 = cy + innerRadius * Math.sin(startAngleRad);

                const largeArcFlag = endAngle - startAngle > 180 ? 1 : 0;

                return `M ${x1} ${y1} A ${outerRadius} ${outerRadius} 0 ${largeArcFlag} 1 ${x2} ${y2} L ${x3} ${y3} A ${innerRadius} ${innerRadius} 0 ${largeArcFlag} 0 ${x4} ${y4} Z`;
            }

            updateLegend(used, remaining) {
                const legendEl = document.getElementById('donut-legend');
                if (!legendEl) return;

                legendEl.innerHTML = '';

                // Used item
                const usedItem = document.createElement('div');
                usedItem.className = 'legend-item';
                usedItem.innerHTML = `
                    <div class="legend-color" style="background: var(--gradient-1);"></div>
                    <span>Used: ${this.formatNumber(used)}</span>
                `;
                legendEl.appendChild(usedItem);

                // Remaining item
                const remainingItem = document.createElement('div');
                remainingItem.className = 'legend-item';
                remainingItem.innerHTML = `
                    <div class="legend-color" style="background: rgba(99, 102, 241, 0.1);"></div>
                    <span>Available: ${this.formatNumber(remaining)}</span>
                `;
                legendEl.appendChild(remainingItem);
            }

            formatNumber(num) {
                if (num >= 1000000) {
                    return (num / 1000000).toFixed(1) + 'M';
                } else if (num >= 1000) {
                    return (num / 1000).toFixed(1) + 'K';
                }
                return Math.floor(num).toString();
            }

            destroy() {
                if (this.countdownInterval) clearInterval(this.countdownInterval);
                if (this.serverSyncInterval) clearInterval(this.serverSyncInterval);
            }
        }

        // Initialize the predictor
        const usagePredictor = new RealTimeUsagePredictor();

        // Update real-time rate limit from headers
        function updateRealTimeRateLimit(limit, remaining) {
            usagePredictor.updateFromRateLimitHeaders(limit, remaining);
        }

        // Load account usage
        async function fetchAccountUsage() {
            try {
                const response = await authenticatedFetch('/api/stats');
                if (response.ok) {
                    const data = await response.json();

                    // Update total stats
                    const totalKeysEl = document.getElementById('total-keys');
                    const totalRequestsEl = document.getElementById('total-requests');
                    const requestsTodayEl = document.getElementById('requests-today');

                    if (totalKeysEl) totalKeysEl.textContent = data.totalApiKeys || 0;
                    if (totalRequestsEl) totalRequestsEl.textContent = usagePredictor.formatNumber(data.totalRequests || 0);
                    if (requestsTodayEl) requestsTodayEl.textContent = usagePredictor.formatNumber(data.requestsToday || 0);

                    // Initialize usage predictor with actual data
                    const rateLimit = data.rateLimit || 10000;
                    const usedRequests = data.requestsThisMonth || 0;
                    const remainingRequests = Math.max(0, rateLimit - usedRequests);

                    usagePredictor.initialize(rateLimit, usedRequests, remainingRequests);
                }
            } catch (error) {
                console.error('Error fetching account usage:', error);
                // Initialize with default values on error
                usagePredictor.initialize(10000, 0, 10000);
            }
        }

        // Load user profile
        
        // Display API keys
        function displayApiKeys(keys) {
            const keysListEl = document.getElementById('api-keys-list');
            if (!keysListEl) return;

            if (keys.length === 0) {
                keysListEl.innerHTML = `
                    <div class="privacy-action">
                        <div class="privacy-action-info">
                            <div class="privacy-action-title">üîë No API Keys</div>
                            <div class="privacy-action-desc">You haven't created any API keys yet. Click "Create New Key" to get started.</div>
                        </div>
                    </div>
                `;
                return;
            }

            keysListEl.innerHTML = keys.map(key => `
                <div class="api-key-card">
                    <div class="api-key-header">
                        <div class="api-key-info">
                            <div class="api-key-name">${key.name || 'Unnamed Key'}</div>
                            <div class="api-key-value">
                                <span>${key.prefix}...</span>
                                <button class="btn btn-sm btn-secondary" onclick="copyToClipboard('${key.prefix}')">Copy</button>
                            </div>
                        </div>
                        <div class="api-key-actions">
                            <button class="btn btn-sm btn-secondary" onclick="copyToClipboard('${key.prefix}')">Copy</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteApiKey('${key.id}', '${key.name || 'Unnamed Key'}')">Delete</button>
                        </div>
                    </div>
                    <div class="api-key-stats">
                        <div class="api-key-stat">
                            <div class="api-key-stat-value">${usagePredictor.formatNumber(key.totalRequests || 0)}</div>
                            <div class="api-key-stat-label">Total Requests</div>
                        </div>
                        <div class="api-key-stat">
                            <div class="api-key-stat-value">${usagePredictor.formatNumber(key.requestsToday || 0)}</div>
                            <div class="api-key-stat-label">Today</div>
                        </div>
                        <div class="api-key-stat">
                            <div class="api-key-stat-value">${new Date(key.createdAt).toLocaleDateString()}</div>
                            <div class="api-key-stat-label">Created</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Modal functions
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            }
        }

        function openCreateKeyModal() {
            openModal('create-key-modal');
        }

        function openDeleteAccountModal() {
            openModal('delete-account-modal');
        }

        // Create API key
        async function createApiKey() {
            const nameInput = document.getElementById('key-name');
            const name = nameInput ? nameInput.value.trim() : '';

            try {
                const response = await authenticatedFetch('/v1/auth/api-key', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name })
                });

                if (response.ok) {
                    const result = await response.json();

                    // Show new key modal
                    const newKeyInput = document.getElementById('new-key-value');
                    if (newKeyInput) {
                        newKeyInput.value = result.apiKey;
                    }

                    closeModal('create-key-modal');
                    openModal('show-key-modal');
                } else {
                    const error = await response.text();
                    throw new Error(error || 'Failed to create API key');
                }
            } catch (error) {
                console.error('Error creating API key:', error);
                showToast('Failed to create API key: ' + error.message, 'error');
            }
        }

        // Delete API key
        function deleteApiKey(keyId, keyName) {
            keyToDelete = { id: keyId, name: keyName };
            openModal('delete-key-modal');
        }

        async function confirmDeleteKey() {
            if (!keyToDelete) return;

            try {
                const response = await authenticatedFetch(`/v1/auth/api-key/${keyToDelete.id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showToast(`API key "${keyToDelete.name}" deleted successfully`, 'success');
                    closeModal('delete-key-modal');
                    loadApiKeys();
                    fetchAccountUsage(); // Refresh usage stats
                } else {
                    const error = await response.text();
                    throw new Error(error || 'Failed to delete API key');
                }
            } catch (error) {
                console.error('Error deleting API key:', error);
                showToast('Failed to delete API key: ' + error.message, 'error');
            }
        }

        // Copy to clipboard
        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                showToast('Copied to clipboard!', 'success');
            } catch (error) {
                console.error('Error copying to clipboard:', error);
                showToast('Failed to copy to clipboard', 'error');
            }
        }

        function copyNewKey() {
            const newKeyInput = document.getElementById('new-key-value');
            if (newKeyInput) {
                copyToClipboard(newKeyInput.value);
            }
        }

        // Export data
        async function requestDataExport() {
            try {
                const response = await authenticatedFetch('/v1/auth/export-data');
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `synaxic-data-export-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    showToast('Data export downloaded successfully', 'success');
                } else {
                    throw new Error('Failed to export data');
                }
            } catch (error) {
                console.error('Error exporting data:', error);
                showToast('Failed to export data: ' + error.message, 'error');
            }
        }

        // Delete account
        async function confirmDeleteAccount() {
            const confirmInput = document.getElementById('delete-confirm');
            if (!confirmInput || confirmInput.value !== 'DELETE') {
                showToast('Please type "DELETE" to confirm account deletion', 'error');
                return;
            }

            try {
                const response = await authenticatedFetch('/v1/auth/delete-account', {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showToast('Account deletion initiated. You will be logged out shortly.', 'success');
                    setTimeout(() => {
                        window.location.href = '/logout';
                    }, 3000);
                } else {
                    const error = await response.text();
                    throw new Error(error || 'Failed to delete account');
                }
            } catch (error) {
                console.error('Error deleting account:', error);
                showToast('Failed to delete account: ' + error.message, 'error');
            }
        }

        // Reset cookie consent
        function resetCookieConsent() {
            localStorage.removeItem('cookieConsent');
            localStorage.removeItem('cookiePreferences');
            showToast('Cookie consent reset. Page will reload to show consent banner.', 'success');
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        }

        // Toast notifications
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;

            document.body.appendChild(toast);

            // Trigger animation
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);

            // Remove after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // Close modals on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const activeModal = document.querySelector('.modal.active');
                if (activeModal) {
                    activeModal.classList.remove('active');
                    document.body.style.overflow = '';
                }
            }
        });

        // Close modals on background click
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
                document.body.style.overflow = '';
            }
        });

        // Initialize everything on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Load user data (will be handled by dashboard.js)
            fetchAccountUsage();

            // Set up form submissions
            const createKeyForm = document.getElementById('create-key-form');
            if (createKeyForm) {
                createKeyForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    createApiKey();
                });
            }

            // Initialize mobile menu if needed
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const navLinks = document.querySelector('.nav-links');

            if (mobileMenuBtn && navLinks) {
                mobileMenuBtn.addEventListener('click', () => {
                    navLinks.classList.toggle('active');
                });
            }
        });

        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            usagePredictor.destroy();
        });
    </script>
</body>
</html>